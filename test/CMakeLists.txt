SET(ROOT_DIR ${CMAKE_CURRENT_SOURCE_DIR})

SET(TEST_OUTPUT_PATH ${CMAKE_SOURCE_DIR}/bin/${CMAKE_BUILD_TYPE}/test)
SET(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${TEST_OUTPUT_PATH})

SET(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -DFORCE_ASSERT")

INCLUDE_DIRECTORIES(${ROOT_DIR})

FILE(GLOB_RECURSE UNITTEST_SOURCES ${SOURCE_DIR}/unittest/*.cpp)

FILE(GLOB SUBDIR_LIST RELATIVE ${ROOT_DIR} ${ROOT_DIR}/*)
LIST(SORT SUBDIR_LIST)

FOREACH (SUBDIR ${SUBDIR_LIST})
    SET(TEST_DIR ${ROOT_DIR}/${SUBDIR})
    IF (IS_DIRECTORY ${TEST_DIR})
        GET_FILENAME_COMPONENT(TEST_NAME ${TEST_DIR} NAME)
        STRING(REPLACE " " "_" TEST_NAME ${TEST_NAME})

        IF (EXISTS ${TEST_DIR}/CMakeLists.txt)
            ADD_SUBDIRECTORY(${TEST_DIR})
        ELSE ()
            ADD_EXECUTABLE(${TEST_NAME} ${TEST_DIR}/main.cpp ${UNITTEST_SOURCES})
        ENDIF ()
    ENDIF ()
ENDFOREACH ()

SET(TESTSUITE_EXECUTABLE ${TEST_OUTPUT_PATH}/run_all_tests.py)
SET(TESTSUITE_EXECUTABLE_SRC ${CMAKE_CURRENT_SOURCE_DIR}/run_all_tests.py)

ADD_CUSTOM_COMMAND(OUTPUT ${TESTSUITE_EXECUTABLE}
                   COMMAND ${CMAKE_COMMAND} -E copy ${TESTSUITE_EXECUTABLE_SRC} ${TESTSUITE_EXECUTABLE}
                   DEPENDS ${TESTSUITE_EXECUTABLE_SRC}
                   COMMENT "Create ${TESTSUITE_EXECUTABLE}")

ADD_CUSTOM_TARGET(CreateTestSuiteExecutable DEPENDS ${TESTSUITE_EXECUTABLE})
