SET(ROOT_DIR ${CMAKE_CURRENT_SOURCE_DIR})

SET(TEST_OUTPUT_PATH_BASE ${CMAKE_SOURCE_DIR}/bin/${CMAKE_BUILD_TYPE}/test)


SET(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -DFORCE_ASSERT")

INCLUDE_DIRECTORIES(${ROOT_DIR})

FILE(GLOB_RECURSE UNIT_TEST_SOURCES ${SOURCE_DIR}/unit_test/*.cpp)

FILE(GLOB PACK_LIST RELATIVE ${ROOT_DIR} ${ROOT_DIR}/*)
LIST(SORT PACK_LIST)

FOREACH (PACK ${PACK_LIST})
    SET(TEST_PACK_DIR ${ROOT_DIR}/${PACK})
    SET(TEST_OUTPUT_PATH ${TEST_OUTPUT_PATH_BASE}/${PACK})
    SET(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${TEST_OUTPUT_PATH})

    FILE(GLOB TEST_LIST RELATIVE ${TEST_PACK_DIR} ${TEST_PACK_DIR}/*)
    LIST(SORT TEST_LIST)

    FOREACH (TEST_DIR ${TEST_LIST})
        SET(TEST_DIR ${TEST_PACK_DIR}/${TEST_DIR})
        IF (IS_DIRECTORY ${TEST_DIR})
            GET_FILENAME_COMPONENT(TEST_NAME ${TEST_DIR} NAME)
            STRING(REPLACE " " "_" TEST_NAME ${TEST_NAME})

            IF (EXISTS ${TEST_DIR}/CMakeLists.txt)
                ADD_SUBDIRECTORY(${TEST_DIR})
            ELSE ()
                ADD_EXECUTABLE(${TEST_NAME} ${TEST_DIR}/main.cpp ${UNIT_TEST_SOURCES})
            ENDIF ()
        ENDIF ()
    ENDFOREACH ()
ENDFOREACH ()

SET(TESTSUITE_EXECUTABLE ${TEST_OUTPUT_PATH_BASE}/run_all_tests.py)
SET(TESTSUITE_EXECUTABLE_SRC ${CMAKE_CURRENT_SOURCE_DIR}/run_all_tests.py)

ADD_CUSTOM_COMMAND(OUTPUT ${TESTSUITE_EXECUTABLE}
                   COMMAND ${CMAKE_COMMAND} -E copy ${TESTSUITE_EXECUTABLE_SRC} ${TESTSUITE_EXECUTABLE}
                   DEPENDS ${TESTSUITE_EXECUTABLE_SRC}
                   COMMENT "Create ${TESTSUITE_EXECUTABLE}")

ADD_CUSTOM_TARGET(CreateTestSuiteExecutable DEPENDS ${TESTSUITE_EXECUTABLE})
